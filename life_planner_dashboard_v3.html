<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåÄ Life Fractal Intelligence</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Auth Screen */
        .auth-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .auth-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 400px;
        }

        .auth-card h1 {
            text-align: center;
            margin-bottom: 10px;
            color: #667eea;
        }

        .auth-card p {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #666;
        }

        .error-msg {
            background: #fee;
            color: #c33;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            text-align: center;
        }

        .success-msg {
            background: #efe;
            color: #3c3;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            text-align: center;
        }

        /* Dashboard */
        .dashboard {
            display: none;
        }

        .dashboard.active {
            display: block;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 28px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info .badge {
            background: #667eea;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stat-box {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .stat-label {
            font-weight: 600;
            color: #555;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
        }

        .habit-item, .goal-item {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .habit-checkbox {
            width: 24px;
            height: 24px;
            cursor: pointer;
        }

        .pet-container {
            text-align: center;
            padding: 20px;
        }

        .pet-avatar {
            width: 150px;
            height: 150px;
            margin: 0 auto 20px;
            font-size: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pet-stats {
            display: grid;
            gap: 10px;
        }

        .pet-action-btns {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .pet-action-btns button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            background: #667eea;
            color: white;
            cursor: pointer;
            font-weight: 600;
        }

        .pet-action-btns button:hover {
            background: #5568d3;
        }

        .fractal-canvas {
            width: 100%;
            height: 400px;
            border-radius: 10px;
            background: #000;
        }

        .guidance-box {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            padding: 20px;
            border-radius: 10px;
            margin-top: 15px;
            border-left: 4px solid #ff6b6b;
        }

        .guidance-box p {
            color: #333;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .mood-selector {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }

        .mood-btn {
            flex: 1;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            font-size: 24px;
            transition: all 0.3s;
        }

        .mood-btn:hover {
            transform: scale(1.05);
        }

        .mood-btn.active {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .slider-container {
            margin: 15px 0;
        }

        .slider-container label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        .slider {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #e0e0e0;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab-btn {
            padding: 12px 24px;
            border: none;
            background: white;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 18px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .spinner {
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
    </style>
</head>
<body>
    <!-- Auth Screen -->
    <div id="authScreen" class="auth-screen">
        <div class="auth-card">
            <h1>üåÄ Life Fractal Intelligence</h1>
            <p>Transform your life through sacred mathematics</p>
            
            <div id="authError" class="error-msg hidden"></div>
            <div id="authSuccess" class="success-msg hidden"></div>

            <div id="loginForm">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <button class="btn btn-primary" onclick="handleLogin()">Login</button>
                <button class="btn btn-secondary" onclick="showRegister()">Create Account</button>
            </div>

            <div id="registerForm" class="hidden">
                <div class="form-group">
                    <label>First Name</label>
                    <input type="text" id="regFirstName" placeholder="John">
                </div>
                <div class="form-group">
                    <label>Last Name</label>
                    <input type="text" id="regLastName" placeholder="Doe">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="regEmail" placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="regPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <button class="btn btn-primary" onclick="handleRegister()">Register (7-Day Free Trial)</button>
                <button class="btn btn-secondary" onclick="showLogin()">Back to Login</button>
            </div>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="dashboard">
        <div class="container">
            <div class="header">
                <h1>üåÄ Life Fractal Intelligence</h1>
                <div class="user-info">
                    <span id="userName"></span>
                    <span class="badge" id="trialBadge"></span>
                    <button class="btn btn-secondary" style="width: auto; padding: 8px 20px;" onclick="logout()">Logout</button>
                </div>
            </div>

            <div class="tabs">
                <button class="tab-btn active" onclick="showTab('overview')">Overview</button>
                <button class="tab-btn" onclick="showTab('today')">Today</button>
                <button class="tab-btn" onclick="showTab('habits')">Habits</button>
                <button class="tab-btn" onclick="showTab('goals')">Goals</button>
                <button class="tab-btn" onclick="showTab('visualization')">Visualization</button>
                <a href="life_planner_3d_visualization.html" target="_blank" 
                   style="padding: 12px 24px; border: none; background: linear-gradient(135deg, #48c774 0%, #3ba368 100%); 
                          border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.3s; 
                          box-shadow: 0 2px 10px rgba(0,0,0,0.1); color: white; text-decoration: none; display: inline-block;">
                    üåÄ Advanced 3D View
                </a>
            </div>

            <!-- Overview Tab -->
            <div id="overviewTab" class="tab-content">
                <div class="grid">
                    <div class="card">
                        <h2>üìä Wellness Dashboard</h2>
                        <div class="stat-box">
                            <span class="stat-label">Wellness Index</span>
                            <span class="stat-value" id="wellnessIndex">--</span>
                        </div>
                        <div class="stat-box">
                            <span class="stat-label">Current Streak</span>
                            <span class="stat-value" id="currentStreak">--</span>
                        </div>
                        <div class="stat-box">
                            <span class="stat-label">Active Goals</span>
                            <span class="stat-value" id="activeGoals">--</span>
                        </div>
                    </div>

                    <div class="card">
                        <h2>ü¶ä Virtual Pet</h2>
                        <div class="pet-container" id="petContainer">
                            <div class="loading">Loading pet...</div>
                        </div>
                    </div>

                    <div class="card">
                        <h2>üéØ Today's Habits</h2>
                        <div id="todayHabits">
                            <div class="loading">Loading habits...</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2>ü§ñ AI Guidance</h2>
                    <div id="guidanceContainer">
                        <div class="loading">Generating guidance...</div>
                    </div>
                </div>
            </div>

            <!-- Today Tab -->
            <div id="todayTab" class="tab-content hidden">
                <div class="card">
                    <h2>üìù How are you feeling today?</h2>
                    
                    <div class="mood-selector">
                        <button class="mood-btn" onclick="setMood(1)" data-mood="1">üò¢</button>
                        <button class="mood-btn" onclick="setMood(2)" data-mood="2">üòï</button>
                        <button class="mood-btn" onclick="setMood(3)" data-mood="3">üòê</button>
                        <button class="mood-btn" onclick="setMood(4)" data-mood="4">üôÇ</button>
                        <button class="mood-btn" onclick="setMood(5)" data-mood="5">üòä</button>
                    </div>

                    <div class="slider-container">
                        <label>Energy Level: <span id="energyValue">50</span></label>
                        <input type="range" class="slider" id="energySlider" min="0" max="100" value="50" oninput="updateSlider('energy', this.value)">
                    </div>

                    <div class="slider-container">
                        <label>Focus & Clarity: <span id="focusValue">50</span></label>
                        <input type="range" class="slider" id="focusSlider" min="0" max="100" value="50" oninput="updateSlider('focus', this.value)">
                    </div>

                    <div class="slider-container">
                        <label>Anxiety Level: <span id="anxietyValue">30</span></label>
                        <input type="range" class="slider" id="anxietySlider" min="0" max="100" value="30" oninput="updateSlider('anxiety', this.value)">
                    </div>

                    <div class="slider-container">
                        <label>Stress Level: <span id="stressValue">30</span></label>
                        <input type="range" class="slider" id="stressSlider" min="0" max="100" value="30" oninput="updateSlider('stress', this.value)">
                    </div>

                    <div class="slider-container">
                        <label>Sleep Hours: <span id="sleepValue">7</span></label>
                        <input type="range" class="slider" id="sleepSlider" min="0" max="12" step="0.5" value="7" oninput="updateSlider('sleep', this.value)">
                    </div>

                    <button class="btn btn-primary" onclick="saveTodayData()">Save Today's Data</button>
                </div>
            </div>

            <!-- Habits Tab -->
            <div id="habitsTab" class="tab-content hidden">
                <div class="card">
                    <h2>‚úÖ My Habits</h2>
                    <div id="habitsList">
                        <div class="loading">Loading habits...</div>
                    </div>
                </div>
            </div>

            <!-- Goals Tab -->
            <div id="goalsTab" class="tab-content hidden">
                <div class="card">
                    <h2>üéØ My Goals</h2>
                    <div id="goalsList">
                        <div class="loading">Loading goals...</div>
                    </div>
                </div>
            </div>

            <!-- Visualization Tab -->
            <div id="visualizationTab" class="tab-content hidden">
                <div class="card">
                    <h2>üåÄ Fractal Visualization</h2>
                    <p>Your life data visualized through sacred geometry and fractal mathematics</p>
                    <div style="text-align: center; margin: 20px 0;">
                        <a href="life_planner_3d_visualization.html" target="_blank" 
                           style="display: inline-block; padding: 15px 30px; background: linear-gradient(135deg, #48c774 0%, #3ba368 100%);
                                  color: white; text-decoration: none; border-radius: 10px; font-weight: 600; font-size: 16px;
                                  box-shadow: 0 5px 20px rgba(72, 199, 116, 0.3); transition: all 0.3s;">
                            üåÄ Open Advanced 3D Visualization
                        </a>
                    </div>
                    <img id="fractalImage" class="fractal-canvas" src="" alt="Loading fractal...">
                    
                    <div class="guidance-box" style="margin-top: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <strong>üó∫Ô∏è What You're Seeing</strong>
                        <p><strong>Fractal Background:</strong> The complex patterns represent the interconnected nature of your life - chaos and order working together.</p>
                        <p><strong>Colors:</strong> Hue shifts based on your mood and energy. Warmer colors (yellow/red) = lower wellness, cooler colors (blue/cyan) = higher wellness.</p>
                        <p><strong>Depth:</strong> Zoom level increases with your wellness index - higher wellness = deeper exploration of possibilities.</p>
                    </div>

                    <div class="guidance-box" style="margin-top: 20px;">
                        <strong>üî¢ Sacred Mathematics in Your Life</strong>
                        <p><strong>Œ¶ (Golden Ratio):</strong> <span id="phiValue">1.618...</span></p>
                        <p>The mathematical proportion found in nature, art, and architecture. Your data points follow this divine ratio for optimal visual harmony.</p>
                        
                        <p style="margin-top: 10px;"><strong>Golden Angle:</strong> <span id="goldenAngleValue">137.5¬∞</span></p>
                        <p>The angle used by sunflowers and galaxies for optimal space filling. Your metrics spiral outward at this angle.</p>
                        
                        <p style="margin-top: 10px;"><strong>Fibonacci Sequence:</strong> <span id="fibonacciSequence">0, 1, 1, 2, 3, 5, 8...</span></p>
                        <p>Ancient sequence where each number is the sum of the two before it. Used for your goal milestones and habit streaks.</p>
                    </div>

                    <div class="guidance-box" style="margin-top: 20px; background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);">
                        <strong>üéØ Data Points in 3D View</strong>
                        <p><strong>Inner Ring (Purple Glow):</strong> Your pet companion - positioned at center, elevation = your wellness</p>
                        <p><strong>Middle Ring (Rainbow Spiral):</strong> 8 wellness metrics (mood, energy, focus, calm, mindfulness, sleep, gratitude, social)</p>
                        <p><strong>Outer Ring (Green/Yellow/Red):</strong> Your active goals - height shows progress, color shows status</p>
                        <p><strong>Far Ring (Green/Orange):</strong> Your habits - size = streak length, green = completed today</p>
                        <p><strong>Connection Lines:</strong> Energy flows between your pet and your wellness metrics - thicker = stronger</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentUser = null;
        let accessToken = null;
        let todayData = {};
        const API_BASE = 'http://localhost:5000/api';

        // Auth Functions
        async function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                showError('Please enter email and password');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (response.ok) {
                    accessToken = data.access_token;
                    currentUser = data.user;
                    localStorage.setItem('accessToken', accessToken);
                    showDashboard();
                } else {
                    showError(data.error || 'Login failed');
                }
            } catch (error) {
                showError('Network error. Please try again.');
                console.error(error);
            }
        }

        async function handleRegister() {
            const firstName = document.getElementById('regFirstName').value;
            const lastName = document.getElementById('regLastName').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;

            if (!email || !password) {
                showError('Please fill in all required fields');
                return;
            }

            if (password.length < 8) {
                showError('Password must be at least 8 characters');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password, first_name: firstName, last_name: lastName })
                });

                const data = await response.json();

                if (response.ok) {
                    accessToken = data.access_token;
                    currentUser = data.user;
                    localStorage.setItem('accessToken', accessToken);
                    showSuccess('Registration successful! Starting 7-day trial...');
                    setTimeout(() => showDashboard(), 1500);
                } else {
                    showError(data.error || 'Registration failed');
                }
            } catch (error) {
                showError('Network error. Please try again.');
                console.error(error);
            }
        }

        function showRegister() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
            clearMessages();
        }

        function showLogin() {
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('loginForm').classList.remove('hidden');
            clearMessages();
        }

        function showError(msg) {
            const el = document.getElementById('authError');
            el.textContent = msg;
            el.classList.remove('hidden');
            document.getElementById('authSuccess').classList.add('hidden');
        }

        function showSuccess(msg) {
            const el = document.getElementById('authSuccess');
            el.textContent = msg;
            el.classList.remove('hidden');
            document.getElementById('authError').classList.add('hidden');
        }

        function clearMessages() {
            document.getElementById('authError').classList.add('hidden');
            document.getElementById('authSuccess').classList.add('hidden');
        }

        function logout() {
            localStorage.removeItem('accessToken');
            accessToken = null;
            currentUser = null;
            document.getElementById('dashboard').classList.remove('active');
            document.getElementById('authScreen').style.display = 'flex';
        }

        // Dashboard Functions
        async function showDashboard() {
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('dashboard').classList.add('active');
            
            // Update user info
            document.getElementById('userName').textContent = currentUser.email;
            document.getElementById('trialBadge').textContent = 
                currentUser.subscription_status === 'trial' 
                    ? `Trial: ${currentUser.trial_days_remaining} days left` 
                    : 'Active';

            // Load dashboard data
            await loadDashboard();
        }

        async function loadDashboard() {
            try {
                const response = await fetch(`${API_BASE}/user/${accessToken}/dashboard`);
                const data = await response.json();

                // Update stats
                document.getElementById('wellnessIndex').textContent = 
                    data.stats.wellness_index.toFixed(1);
                document.getElementById('currentStreak').textContent = 
                    data.stats.current_streak + ' days';
                document.getElementById('activeGoals').textContent = 
                    data.stats.active_goals;

                // Load pet
                loadPet(data.pet);

                // Load habits
                loadHabits(data.habits);

                // Load goals
                loadGoals(data.goals);

                // Load guidance
                loadGuidance();

                // Load visualization
                loadVisualization();

            } catch (error) {
                console.error('Dashboard load error:', error);
            }
        }

        function loadPet(pet) {
            if (!pet) return;

            const emojis = {
                cat: 'üê±',
                dragon: 'üêâ',
                phoenix: 'üî•',
                owl: 'ü¶â',
                fox: 'ü¶ä'
            };

            const html = `
                <div class="pet-avatar">${emojis[pet.species] || 'üê±'}</div>
                <h3>${pet.name} - Level ${pet.level}</h3>
                <p style="color: #666; margin: 10px 0;">Behavior: ${pet.behavior}</p>
                <div class="pet-stats">
                    <div>
                        <small>Hunger</small>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${pet.hunger}%"></div>
                        </div>
                    </div>
                    <div>
                        <small>Energy</small>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${pet.energy}%"></div>
                        </div>
                    </div>
                    <div>
                        <small>Mood</small>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${pet.mood}%"></div>
                        </div>
                    </div>
                    <div>
                        <small>Bond</small>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${pet.bond}%"></div>
                        </div>
                    </div>
                </div>
                <div class="pet-action-btns">
                    <button onclick="feedPet()">üçñ Feed</button>
                    <button onclick="playPet()">üéæ Play</button>
                </div>
            `;

            document.getElementById('petContainer').innerHTML = html;
        }

        async function feedPet() {
            try {
                const response = await fetch(`${API_BASE}/user/${accessToken}/pet/feed`, {
                    method: 'POST'
                });
                const data = await response.json();
                if (data.success) {
                    loadPet(data.pet);
                }
            } catch (error) {
                console.error('Feed error:', error);
            }
        }

        async function playPet() {
            try {
                const response = await fetch(`${API_BASE}/user/${accessToken}/pet/play`, {
                    method: 'POST'
                });
                const data = await response.json();
                if (data.success) {
                    loadPet(data.pet);
                }
            } catch (error) {
                console.error('Play error:', error);
            }
        }

        function loadHabits(habits) {
            const todayContainer = document.getElementById('todayHabits');
            const habitsContainer = document.getElementById('habitsList');

            if (!habits || habits.length === 0) {
                todayContainer.innerHTML = '<p>No habits yet. Add some in the Habits tab!</p>';
                habitsContainer.innerHTML = '<p>No habits yet.</p>';
                return;
            }

            const todayHtml = habits.slice(0, 5).map(h => `
                <div class="habit-item">
                    <span>${h.name}</span>
                    <input type="checkbox" class="habit-checkbox" 
                           onchange="toggleHabit('${h.id}', this.checked)">
                </div>
            `).join('');

            const habitsHtml = habits.map(h => `
                <div class="habit-item">
                    <div>
                        <strong>${h.name}</strong>
                        <br><small>${h.category} ‚Ä¢ Streak: ${h.current_streak} days</small>
                    </div>
                    <input type="checkbox" class="habit-checkbox" 
                           onchange="toggleHabit('${h.id}', this.checked)">
                </div>
            `).join('');

            todayContainer.innerHTML = todayHtml;
            habitsContainer.innerHTML = habitsHtml;
        }

        async function toggleHabit(habitId, completed) {
            try {
                await fetch(`${API_BASE}/user/${accessToken}/habits/${habitId}/complete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ completed })
                });
                loadDashboard();
            } catch (error) {
                console.error('Toggle habit error:', error);
            }
        }

        function loadGoals(goals) {
            const container = document.getElementById('goalsList');

            if (!goals || goals.length === 0) {
                container.innerHTML = '<p>No goals yet.</p>';
                return;
            }

            const html = goals.map(g => `
                <div class="goal-item">
                    <div style="flex: 1;">
                        <strong>${g.title}</strong>
                        <br><small>${g.category} ‚Ä¢ Priority: ${g.priority}</small>
                        <div class="progress-bar" style="margin-top: 8px;">
                            <div class="progress-fill" style="width: ${g.progress}%"></div>
                        </div>
                        <small>${g.progress.toFixed(0)}% Complete</small>
                    </div>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        async function loadGuidance() {
            try {
                const response = await fetch(`${API_BASE}/user/${accessToken}/guidance`);
                const data = await response.json();

                const html = `
                    <div class="guidance-box">
                        <strong>üéØ Your Guidance</strong>
                        <p>${data.fuzzy_message}</p>
                        <p><strong>${data.pet_message}</strong></p>
                        <p><small>Predicted Mood Tomorrow: ${data.predicted_mood.toFixed(0)}/100</small></p>
                    </div>
                `;

                document.getElementById('guidanceContainer').innerHTML = html;
            } catch (error) {
                console.error('Guidance error:', error);
            }
        }

        async function loadVisualization() {
            try {
                // Load visualization parameters
                const paramsResponse = await fetch(`${API_BASE}/user/${accessToken}/visualization`);
                const params = await paramsResponse.json();

                // Update sacred math display
                document.getElementById('phiValue').textContent = params.sacred_math.phi.toFixed(15);
                document.getElementById('goldenAngleValue').textContent = params.sacred_math.golden_angle.toFixed(4) + '¬∞';
                document.getElementById('fibonacciSequence').textContent = params.sacred_math.fibonacci.join(', ');

                // Load fractal image
                const imageUrl = `${API_BASE}/user/${accessToken}/fractal?t=${Date.now()}`;
                document.getElementById('fractalImage').src = imageUrl;
            } catch (error) {
                console.error('Visualization error:', error);
            }
        }

        // Tab Navigation
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });

            // Remove active class from all buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.remove('hidden');

            // Add active class to button
            event.target.classList.add('active');
        }

        // Today's Data
        function setMood(level) {
            document.querySelectorAll('.mood-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            todayData.mood_level = level;
            todayData.mood_score = level * 20;
        }

        function updateSlider(type, value) {
            document.getElementById(type + 'Value').textContent = value;
            
            const mappings = {
                energy: 'energy_level',
                focus: 'focus_clarity',
                anxiety: 'anxiety_level',
                stress: 'stress_level',
                sleep: 'sleep_hours'
            };

            todayData[mappings[type]] = parseFloat(value);
        }

        async function saveTodayData() {
            try {
                const response = await fetch(`${API_BASE}/user/${accessToken}/today`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(todayData)
                });

                if (response.ok) {
                    alert('‚úÖ Data saved successfully!');
                    loadDashboard();
                    showTab('overview');
                }
            } catch (error) {
                console.error('Save error:', error);
                alert('‚ùå Failed to save data');
            }
        }

        // Initialize
        window.onload = function() {
            const token = localStorage.getItem('accessToken');
            if (token) {
                accessToken = token;
                // Verify token and load user
                fetch(`${API_BASE}/user/${token}`)
                    .then(r => r.json())
                    .then(data => {
                        if (data.id) {
                            currentUser = data;
                            showDashboard();
                        }
                    })
                    .catch(() => {
                        localStorage.removeItem('accessToken');
                    });
            }
        };
    </script>
</body>
</html>
